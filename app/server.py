import aiohttp
import asyncio
import uvicorn
from fastai import *
from fastai.vision import *
from io import BytesIO
from starlette.applications import Starlette
from starlette.middleware.cors import CORSMiddleware
from starlette.responses import HTMLResponse, JSONResponse
from starlette.staticfiles import StaticFiles

export_file_url = 'https://drive.google.com/uc?export=download&id=1--fiDKHx_oVqogOIT4zqyE1R6Ov-vOW_'
export_file_name = 'trained_model_2.pkl'

classes = ['Aberrant bush warbler', 'Alexandrine parakeet', 'Alpine chough', 'Alpine swift', 'Amur falcon', 'Amur paradise flycatcher', 'Andaman bulbul', 'Andaman coucal', 'Andaman crake', 'Andaman cuckoo-dove', 'Andaman drongo', 'Andaman green pigeon', 'Andaman hawk-owl', 'Andaman masked owl', 'Andaman nightjar', 'Andaman scops owl', 'Andaman serpent eagle', 'Andaman teal', 'Arctic tern', 'Arctic warbler', 'Ashy drongo', 'Ashy minivet', 'Ashy wood pigeon', 'Ashy woodswallow', 'Ashy-crowned sparrow-lark', 'Asian barred owlet', 'Asian emerald cuckoo', 'Asian house martin', 'Asian koel', 'Asian openbill', 'Asian palm swift', 'Asian short-toed lark', 'Asian stubtail', "Austen's brown hornbill", "Baer's pochard", 'Baikal teal', 'Banded bay cuckoo', 'Bar-tailed godwit', 'Bar-winged flycatcher-shrike', "Barau's petrel", 'Barn swallow', 'Barred buttonquail', 'Barred cuckoo-dove', 'Bay woodpecker', 'Bay-backed shrike', 'Beach stone-curlew', 'Bengal bush lark', 'Bengal florican', "Bianchi's warbler", 'Bimaculated lark', 'Black baza', 'Black bittern', 'Black bulbul', 'Black eagle', 'Black francolin', 'Black kite', 'Black noddy', 'Black stork', 'Black tern', 'Black-bellied sandgrouse', 'Black-bellied tern', 'Black-browed bushtit', 'Black-browed reed warbler', 'Black-crowned night heron', 'Black-crowned sparrow-lark', 'Black-eared shrike-babbler', 'Black-faced warbler', 'Black-headed bulbul', 'Black-headed cuckooshrike', 'Black-headed gull', 'Black-headed ibis', 'Black-headed jay', 'Black-headed shrike-babbler', 'Black-legged kittiwake', 'Black-naped monarch', 'Black-naped oriole', 'Black-naped tern', 'Black-necked grebe', 'Black-necked stork', 'Black-rumped flameback', 'Black-rumped magpie', 'Black-tailed crake', 'Black-tailed godwit', 'Black-throated bushtit', 'Black-throated loon', 'Black-winged cuckooshrike', 'Black-winged kite', 'Black-winged stilt', 'Blossom-headed parakeet', 'Blue pitta', 'Blue-cheeked bee-eater', 'Blue-eared barbet', 'Blue-eared kingfisher', 'Blue-faced malkoha', 'Blue-tailed bee-eater', 'Blue-throated barbet', 'Blue-throated bee-eater', 'Blue-winged parakeet', 'Blue-winged pitta', 'Blunt-winged warbler', "Blyth's kingfisher", "Blyth's paradise flycatcher", "Blyth's reed warbler", "Blyth's swift", "Blyth's tragopan", 'Bohemian waxwing', "Bonelli's eagle", 'Booted eagle', 'Booted warbler', 'Boreal owl', 'Brahminy kite', 'Bridled tern', 'Broad-billed sandpiper', 'Broad-billed warbler', 'Bronze-winged jacana', 'Bronzed drongo', "Brooks's leaf warbler", 'Brown booby', 'Brown crake', 'Brown fish owl', 'Brown hawk-owl', 'Brown noddy', 'Brown shrike', 'Brown skua', 'Brown wood owl', 'Brown-backed needletail', 'Brown-capped pygmy woodpecker', 'Brown-cheeked rail', 'Brown-flanked bush warbler', 'Brown-fronted woodpecker', 'Brown-headed gull', 'Brown-winged kingfisher', 'Buff-breasted sandpiper', 'Buff-throated warbler', 'Buffy fish owl', 'Burmese bushtit', 'Burmese shrike', 'Cachar bulbul', 'Cape petrel', 'Carrion crow', 'Caspian gull', 'Caspian plover', 'Caspian tern', "Cetti's warbler", 'Changeable hawk-eagle', 'Cheer pheasant', 'Chestnut-crowned warbler', 'Chestnut-headed bee-eater', 'Chestnut-headed tesia', 'Chestnut-winged cuckoo', 'Chinese egret', 'Chinese pond heron', 'Chinese sparrowhawk', 'Christmas frigatebird', 'Chukar partridge', 'Cinereous tit', 'Cinereous vulture', 'Cinnamon bittern', 'Clamorous reed warbler', "Claudia's leaf warbler", 'Clicking shrike-babbler', 'Coal tit', 'Collared falconet', 'Collared owlet', 'Collared pratincole', 'Collared scops owl', 'Collared treepie', 'Common buttonquail', 'Common buzzard', 'Common crane', 'Common cuckoo', 'Common flameback', 'Common green magpie', 'Common greenshank', 'Common gull', 'Common hawk-cuckoo', 'Common house martin', 'Common iora', 'Common kestrel', 'Common merganser', 'Common moorhen', 'Common raven', 'Common redshank', 'Common ringed plover', 'Common sandpiper', 'Common shelduck', 'Common snipe', 'Common tern', 'Common wood pigeon', 'Common woodshrike', 'Coppersmith barbet', 'Corn crake', "Cory's shearwater", 'Cotton pygmy-goose', 'Crab-plover', 'Cream-colored courser', 'Crested finchbill', 'Crested goshawk', 'Crested honey buzzard', 'Crested lark', 'Crested serpent eagle', 'Crested tit-warbler', 'Crested treeswift', 'Crimson-breasted woodpecker', 'Crow-billed drongo', 'Curlew sandpiper', 'Dalmatian pelican', 'Darjeeling woodpecker', 'Dark-rumped swift', 'Demoiselle crane', 'Desert lark', 'Dusky eagle-owl', 'Dusky warbler', 'Eastern barn owl', 'Eastern cattle egret', 'Eastern grass owl', 'Eastern jungle crow', 'Eastern marsh harrier', 'Eastern spot-billed duck', 'Edible-nest swiftlet', 'Egyptian vulture', 'Eurasian collared dove', 'Eurasian coot', 'Eurasian crag martin', 'Eurasian curlew', 'Eurasian eagle-owl', 'Eurasian golden oriole', 'Eurasian hobby', 'Eurasian hoopoe', 'Eurasian jay', 'Eurasian magpie', 'Eurasian nutcracker', 'Eurasian oystercatcher', 'Eurasian sparrowhawk', 'Eurasian spoonbill', 'Eurasian stone-curlew', 'Eurasian teal', 'Eurasian wigeon', 'Eurasian woodcock', 'Eurasian wryneck', 'European golden plover', 'European nightjar', 'European roller', 'European turtle dove', 'Falcated duck', 'Ferruginous duck', 'Fire-capped tit', 'Flame-throated bulbul', 'Flavescent bulbul', 'Flesh-footed shearwater', 'Forest owlet', 'Fork-tailed drongo-cuckoo', "Franklin's gull", 'Freckle-breasted woodpecker', 'Fulvous whistling duck', 'Fulvous-breasted woodpecker', 'Gadwall', 'Garganey', 'Glossy ibis', 'Golden eagle', 'Golden-throated barbet', 'Goliath heron', 'Great Indian bustard', 'Great Nicobar serpent eagle', 'Great barbet', 'Great cormorant', 'Great crested grebe', 'Great egret', 'Great grey shrike', 'Great hornbill', 'Great knot', 'Great reed warbler', 'Great slaty woodpecker', 'Great snipe', 'Great spotted woodpecker', 'Great stone-curlew', 'Great tit', 'Great white pelican', 'Great-billed heron', 'Greater adjutant', 'Greater crested tern', 'Greater flameback', 'Greater hoopoe-lark', 'Greater painted-snipe', 'Greater racket-tailed drongo', 'Greater sand plover', 'Greater scaup', 'Greater short-toed lark', 'Greater spotted eagle', 'Greater white-fronted goose', 'Greater yellownape', 'Green bee-eater', 'Green imperial pigeon', 'Green peafowl', 'Green-backed tit', 'Green-billed malkoha', 'Green-crowned warbler', 'Greenish warbler', 'Grey francolin', 'Grey hypocolius', 'Grey nightjar', 'Grey peacock-pheasant', 'Grey treepie', 'Grey-bellied cuckoo', 'Grey-bellied tesia', 'Grey-capped pygmy woodpecker', 'Grey-cheeked warbler', 'Grey-chinned minivet', 'Grey-crested tit', 'Grey-crowned warbler', 'Grey-faced buzzard', 'Grey-fronted green pigeon', 'Grey-headed bulbul', 'Grey-headed canary-flycatcher', 'Grey-headed fish eagle', 'Grey-headed lapwing', 'Grey-headed woodpecker', 'Grey-hooded warbler', 'Grey-sided bush warbler', 'Grey-tailed tattler', 'Grey-throated martin', 'Greylag goose', 'Ground tit', 'Gull-billed tern', 'Hair-crested drongo', 'Heart-spotted woodpecker', 'Hen harrier', 'Hill partridge', 'Hill pigeon', 'Hill swallow', 'Himalayan black-lored tit', 'Himalayan bulbul', 'Himalayan buzzard', 'Himalayan cuckoo', 'Himalayan flameback', 'Himalayan monal', 'Himalayan quail', 'Himalayan shrike-babbler', 'Himalayan snowcock', 'Himalayan swiftlet', 'Himalayan vulture', "Hodgson's frogmouth", "Hodgson's hawk-cuckoo", 'Hooded crow', 'Hooded pitta', 'Horned grebe', 'Horned lark', "Horsfield's bronze cuckoo", 'Houbara bustard', 'House crow', 'House swift', "Hume's bush warbler", "Hume's hawk-owl", "Hume's leaf warbler", "Hume's short-toed lark", 'Ibisbill', 'Indian black-lored tit', 'Indian bush lark', 'Indian cormorant', 'Indian courser', 'Indian cuckoo', 'Indian eagle-owl', 'Indian golden oriole', 'Indian grey hornbill', 'Indian jungle crow', 'Indian paradise flycatcher', 'Indian peafowl', 'Indian pitta', 'Indian pond heron', 'Indian spot-billed duck', 'Indian spotted eagle', 'Indian stone-curlew', 'Indian swiftlet', 'Indochinese roller', 'Intermediate egret', 'Isabelline shrike', 'Jack snipe', 'Japanese paradise flycatcher', 'Japanese quail', 'Japanese sparrowhawk', 'Javan pond heron', "Jerdon's baza", "Jerdon's courser", "Jerdon's nightjar", 'Jungle bush quail', 'Jungle nightjar', 'Jungle owlet', 'Kentish plover', 'King quail', 'Knob-billed duck', 'Koklass pheasant', 'Laggar falcon', 'Large cuckooshrike', 'Large hawk-cuckoo', 'Large woodshrike', 'Large-billed crow', 'Large-billed reed warbler', 'Large-spotted nutcracker', 'Large-tailed nightjar', 'Laughing dove', "Legge's hawk-eagle", 'Lemon-rumped warbler', 'Lesser adjutant', 'Lesser black-backed gull', 'Lesser coucal', 'Lesser crested tern', 'Lesser cuckoo', 'Lesser fish eagle', 'Lesser flamingo', 'Lesser florican', 'Lesser frigatebird', 'Lesser grey shrike', 'Lesser kestrel', 'Lesser racket-tailed drongo', 'Lesser sand plover', 'Lesser short-toed lark', 'Lesser whistling duck', 'Lesser white-fronted goose', 'Lineated barbet', 'Little bittern', 'Little bustard', 'Little cormorant', 'Little crake', 'Little egret', 'Little grebe', 'Little gull', 'Little owl', 'Little ringed plover', 'Little swift', 'Little tern', 'Long-billed dowitcher', 'Long-billed plover', 'Long-eared owl', 'Long-legged buzzard', 'Long-tailed broadbill', 'Long-tailed jaeger', 'Long-tailed minivet', 'Long-tailed shrike', 'Long-toed stint', "Lord Derby's parakeet", "MacQueen's bustard", 'Malabar grey hornbill', 'Malabar lark', 'Malabar pied hornbill', 'Malabar trogon', 'Malayan night heron', 'Mallard', 'Manchurian bush warbler', 'Mandarin duck', 'Mangrove pitta', 'Mangrove whistler', 'Manipur bush quail', 'Maroon oriole', 'Marsh sandpiper', "Marshall's iora", 'Masked booby', 'Masked finfoot', 'Masked shrike', 'Merlin (bird)', 'Mongolian short-toed lark', "Montagu's harrier", 'Mottled wood owl', 'Mountain bamboo partridge', 'Mountain bulbul', 'Mountain chiffchaff', 'Mountain hawk-eagle', 'Mountain scops owl', 'Moustached warbler', 'Mute swan', 'Narcondam hornbill', 'Nepal cupwing', 'Nepal house martin', 'Nicobar bulbul', 'Nicobar parakeet', 'Nicobar pigeon', 'Nicobar scops owl', 'Nicobar scrubfowl', 'Nicobar sparrowhawk', 'Nilgiri wood pigeon', 'Northern goshawk', 'Northern lapwing', 'Northern pintail', 'Northern shoveler', 'Orange minivet', 'Orange-breasted green pigeon', 'Oriental dollarbird', 'Oriental dwarf kingfisher', 'Oriental hobby', 'Oriental pied hornbill', 'Oriental plover', 'Oriental pratincole', 'Oriental reed warbler', 'Oriental turtle dove', 'Pacific reef heron', 'Pacific swallow', 'Pacific swift', 'Paddyfield warbler', 'Painted bush quail', 'Painted francolin', 'Painted sandgrouse', 'Painted stork', 'Pale martin', 'Pale-capped pigeon', 'Pale-footed bush warbler', 'Pale-headed woodpecker', 'Pale-legged leaf warbler', "Pallas's fish eagle", "Pallas's gull", "Pallas's sandgrouse", 'Pallid harrier', 'Pallid scops owl', 'Pallid swift', 'Parasitic jaeger', 'Pectoral sandpiper', 'Peregrine falcon', 'Persian shearwater', 'Pheasant-tailed jacana', 'Pied crow', 'Pied falconet', 'Pied harrier', 'Pied imperial pigeon', 'Pied kingfisher', 'Pin-tailed sandgrouse', 'Pin-tailed snipe', 'Pink-headed duck', 'Plain leaf warbler', 'Plaintive cuckoo', 'Plum-headed parakeet', 'Plume-toed swiftlet', 'Pomarine jaeger', 'Purple heron', 'Rain quail', 'Red junglefowl', 'Red kite', 'Red knot', 'Red phalarope', 'Red spurfowl', 'Red turtle dove', 'Red-backed shrike', 'Red-billed blue magpie', 'Red-billed chough', 'Red-billed tropicbird', 'Red-breasted goose', 'Red-breasted merganser', 'Red-breasted parakeet', 'Red-crested pochard', 'Red-footed booby', 'Red-footed falcon', 'Red-headed vulture', 'Red-naped ibis', 'Red-necked falcon', 'Red-necked grebe', 'Red-necked phalarope', 'Red-necked stint', 'Red-rumped swallow', 'Red-tailed tropicbird', 'Red-vented bulbul', 'Red-wattled lapwing', 'Red-whiskered bulbul', 'River lapwing', 'Rock bush quail', 'Rook (bird)', 'Rose-ringed parakeet', 'Roseate tern', 'Rosy minivet', 'Ruddy kingfisher', 'Ruddy shelduck', 'Ruddy turnstone', 'Ruddy-breasted crake', 'Ruff', 'Rufous treepie', 'Rufous woodpecker', 'Rufous-bellied hawk-eagle', 'Rufous-faced warbler', 'Rufous-naped tit', 'Rufous-necked hornbill', 'Rufous-tailed lark', 'Rufous-throated partridge', 'Rufous-vented tit', "Sabine's gull", 'Saker falcon', "Salim Ali's swift", 'Sand martin', 'Sanderling', 'Sandwich tern', "Saunders's tern", 'Savanna nightjar', 'Scaly-bellied woodpecker', 'Scaly-breasted cupwing', 'Scarlet minivet', "Sclater's monal", "Scopoli's shearwater", 'Sedge warbler', 'Shikra', 'Short-tailed shearwater', 'Short-toed snake eagle', 'Silver-backed needletail', 'Silver-breasted broadbill', 'Sind woodpecker', 'Singing bush lark', 'Sirkeer malkoha', 'Slaty-breasted rail', 'Slaty-headed parakeet', 'Slaty-legged crake', 'Slender-billed gull', 'Slender-billed oriole', 'Slender-billed vulture', 'Small pratincole', 'Smew', 'Smoky warbler', 'Snow partridge', 'Snow pigeon', 'Sociable lapwing', 'Sooty gull', 'South polar skua', 'Speckled piculet', 'Speckled wood pigeon', 'Spoon-billed sandpiper', 'Spot-billed pelican', 'Spotted crake', 'Spotted dove', 'Spotted owlet', 'Spotted redshank', 'Square-tailed drongo-cuckoo', 'Sri Lanka bay owl', 'Sri Lanka frogmouth', 'Steppe eagle', 'Stork-billed kingfisher', 'Streak-throated woodpecker', 'Streaked shearwater', 'Striated bulbul', 'Striated heron', 'Striated swallow', 'Stripe-breasted woodpecker', 'Sulphur-bellied warbler', 'Sultan tit', "Swinhoe's minivet", "Swinhoe's snipe", "Swinhoe's storm petrel", "Sykes's lark", "Sykes's nightjar", 'Taiga bean goose', 'Tawny eagle', 'Tawny fish owl', 'Tawny owl', "Temminck's tragopan", 'Terek sandpiper', 'Thick-billed green pigeon', 'Tibetan eared pheasant', 'Tibetan lark', 'Tibetan partridge', 'Tibetan sandgrouse', 'Tibetan snowcock', "Tickell's leaf warbler", 'Tropical shearwater', 'Tufted duck', 'Tundra bean goose', 'Tundra swan', 'Two-barred warbler', "Tytler's leaf warbler", 'Upland buzzard', 'Vega gull', 'Vernal hanging parrot', 'Violet cuckoo', "Ward's trogon", 'Water rail', 'Watercock', 'Wedge-tailed green pigeon', 'Wedge-tailed shearwater', 'Western crowned leaf warbler', 'Western jackdaw', 'Western marsh harrier', 'Western osprey', 'Western reef heron', 'Western tragopan', 'Whimbrel', 'Whiskered tern', "Whistler's warbler", 'White stork', 'White tern', 'White-bellied drongo', 'White-bellied erpornis', 'White-bellied heron', 'White-bellied minivet', 'White-bellied sea eagle', 'White-bellied storm petrel', 'White-bellied treepie', 'White-bellied woodpecker', 'White-breasted waterhen', 'White-breasted woodswallow', 'White-browed bulbul', 'White-browed crake', 'White-browed fantail', 'White-browed piculet', 'White-browed tit-warbler', 'White-cheeked barbet', 'White-cheeked bushtit', 'White-cheeked partridge', 'White-crowned penduline tit', 'White-eared bulbul', 'White-eared night heron', 'White-eyed buzzard', 'White-faced plover', 'White-faced storm petrel', 'White-headed duck', 'White-naped tit', 'White-naped woodpecker', 'White-rumped vulture', 'White-spectacled warbler', 'White-tailed eagle', 'White-tailed lapwing', 'White-throated bulbul', 'White-throated bushtit', 'White-throated fantail', 'White-throated kingfisher', 'White-throated needletail', 'White-winged duck', 'White-winged tern', 'Whooper swan', 'Wire-tailed swallow', 'Wood sandpiper', 'Wood snipe', 'Wood warbler', 'Woodchat shrike', 'Woolly-necked stork', 'Yellow bittern', 'Yellow-bellied warbler', 'Yellow-billed blue magpie', 'Yellow-browed bulbul', 'Yellow-browed tit', 'Yellow-crowned woodpecker', 'Yellow-eyed pigeon', 'Yellow-footed green pigeon', 'Yellow-rumped honeyguide', 'Yellow-throated bulbul', 'Yellow-vented warbler', 'Yellow-wattled lapwing']
path = Path(__file__).parent

app = Starlette()
app.add_middleware(CORSMiddleware, allow_origins=['*'], allow_headers=['X-Requested-With', 'Content-Type'])
app.mount('/static', StaticFiles(directory='app/static'))


async def download_file(url, dest):
    if dest.exists(): return
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            data = await response.read()
            with open(dest, 'wb') as f:
                f.write(data)


async def setup_learner():
    await download_file(export_file_url, path / export_file_name)
    try:
        learn = load_learner(path, export_file_name)
        return learn
    except RuntimeError as e:
        if len(e.args) > 0 and 'CPU-only machine' in e.args[0]:
            print(e)
            message = "\n\nThis model was trained with an old version of fastai and will not work in a CPU environment.\n\nPlease update the fastai library in your training environment and export your model again.\n\nSee instructions for 'Returning to work' at https://course.fast.ai."
            raise RuntimeError(message)
        else:
            raise


loop = asyncio.get_event_loop()
tasks = [asyncio.ensure_future(setup_learner())]
learn = loop.run_until_complete(asyncio.gather(*tasks))[0]
loop.close()


@app.route('/')
async def homepage(request):
    html_file = path / 'view' / 'index.html'
    return HTMLResponse(html_file.open().read())


@app.route('/analyze', methods=['POST'])
async def analyze(request):
    img_data = await request.form()
    img_bytes = await (img_data['file'].read())
    img = open_image(BytesIO(img_bytes))
    prediction = learn.predict(img)[0]
    return JSONResponse({'result': str(prediction)})


if __name__ == '__main__':
    if 'serve' in sys.argv:
        uvicorn.run(app=app, host='0.0.0.0', port=5000, log_level="info")
